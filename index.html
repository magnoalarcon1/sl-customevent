<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sendlane Custom Events POC</title>

    <script>
        // Sendlane Configuration - Update these values as needed
        const SENDLANE_TOKEN = 'db9ab736-afaf-42f4-af04-695828a31bda';
        const SENDLANE_EVENT_ID = 'event_1234';

        // Initialize Sendlane queue first
        window._Sendlane = window._Sendlane || [];

        // Load Sendlane script
        console.log('ðŸš€ Loading Sendlane script...');
        const script = document.createElement('script');
        script.src = 'https://sendlane.com/scripts/pusher.js';
        script.async = true;
        script.setAttribute('data-token', SENDLANE_TOKEN);
        document.head.appendChild(script);

        // Variable to track if Sendlane is ready
        let sendlaneReady = false;

        script.onload = function() {
            console.log('âœ… Sendlane script loaded successfully');

            // Initialize Beacon with event_id (required for proper tracking)
            try {
                _Sendlane.push({ event_id: SENDLANE_EVENT_ID });
                sendlaneReady = true;
                console.log('âœ… Sendlane Beacon initialized with event_id');
            } catch (error) {
                console.error('âŒ Error initializing Sendlane Beacon:', error);
            }
        };

        script.onerror = function() {
            console.error('âŒ Error loading Sendlane script');
            sendlaneReady = false;
        };

        function sendCustomEvent() {
            const email = document.getElementById('email').value;

            if (!email) {
                console.warn('âš ï¸ Please enter an email');
                alert('Please enter an email');
                return;
            }

            if (!sendlaneReady) {
                console.error('âŒ Sendlane not ready yet');
                alert('Sendlane is still loading, please wait and try again');
                return;
            }

            console.log('ðŸ“§ Email captured:', email);
            console.log('ðŸ”„ Identifying contact and sending event...');

            try {
                // First, identify/add the contact to Sendlane
                _Sendlane.push({
                    email: email
                });
                console.log('âœ… Contact identified:', email);

                // Wait a moment for contact identification, then send custom event
                setTimeout(() => {
                    // Event structure following woodworkerssource.com pattern
                    const customEventData = {
                        "event": SENDLANE_EVENT_ID,
                        "email": email,
                        // Custom fields directly in the event object
                        "product_id": "poc-test-001",
                        "product_name": "Test Product POC",
                        "category": "testing",
                        "price": 99.99,
                        "customer_segment": "poc_tester",
                        "source": "html_poc",
                        "timestamp": new Date().toISOString(),
                        // Additional fields that could come from MIVA
                        "order_value": 150.00,
                        "customer_type": "returning",
                        "purchase_intent": "high"
                    };

                    console.log('ðŸ“¦ Event data:', JSON.stringify(customEventData, null, 2));

                    // Send the custom event
                    _Sendlane.push(customEventData);
                    console.log('âœ… Event sent successfully');
                    console.log('ðŸ” Check Network tab to see HTTP calls');
                    alert('Contact added and event sent! Check console for details');

                }, 500); // Small delay to ensure contact is processed first

            } catch (error) {
                console.error('âŒ Error sending to Sendlane:', error);
                alert('Error: ' + error.message);
            }
        }

        // Additional debugging functions
        function checkSendlaneStatus() {
            console.log('ðŸ“Š Sendlane Status Check:');
            console.log('- Script ready:', sendlaneReady);
            console.log('- _Sendlane object:', window._Sendlane);
            console.log('- Queue length:', window._Sendlane ? window._Sendlane.length : 'N/A');
        }

        // Make status check available globally for debugging
        window.checkSendlaneStatus = checkSendlaneStatus;

        // Additional logging for debugging
        console.log('ðŸ› Sendlane Custom Events POC started');
        console.log('ðŸ“‹ Token used:', SENDLANE_TOKEN);
        console.log('ðŸ†” Event ID used:', SENDLANE_EVENT_ID);
        console.log('ðŸ’¡ Tip: Use checkSendlaneStatus() in console to debug');

        // Check status after a delay to see initial state
        setTimeout(() => {
            checkSendlaneStatus();
        }, 2000);
    </script>
</head>
<body>
    <h1>Sendlane Custom Events POC</h1>
    <p>Proof of concept to send custom fields using custom events</p>

    <div>
        <label for="email">Email:</label>
        <input type="email" id="email" placeholder="example@email.com">
        <button onclick="sendCustomEvent()">Send Custom Event</button>
    </div>
</body>
</html>